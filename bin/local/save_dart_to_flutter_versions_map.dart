import 'dart:io';

import 'package:pub_semver/pub_semver.dart';

import '../util/log_info.dart';

/// Saves the provided Dart-to-Flutter version mappings to a specified file.
///
/// This method generates Dart code representing the provided [dartToFlutterMap]
/// and writes it to the specified [outputFile]. The generated file is intended
/// to be machine-generated and should not be modified manually.
///
/// Throws:
/// - [FileSystemException] if the [outputFile] does not exist.
///
/// Parameters:
/// - [outputFile]: The file to which the Dart-to-Flutter map will be saved.
/// - [dartToFlutterMap]: A map of Dart [Version] to Flutter [Version] to save.
///
/// Example Generated Output:
/// ```dart
/// // GENERATED CODE - DO NOT MODIFY BY HAND
/// import 'package:pub_semver/pub_semver.dart';
///
/// /// This is a map of Dart SDK versions to Flutter SDK versions.
/// ///
/// /// Key: Dart SDK version
/// /// Value: Flutter SDK version
/// final dartToFlutterMap = {
///   Version.parse('2.19.1'): Version.parse('3.7.1'),
///   Version.parse('2.18.0'): Version.parse('3.6.0'),
/// };
/// ```
Future<void> saveDartToFlutterVersionsMap({
  required File outputFile,
  required Map<Version, Version> dartToFlutterMap,
}) async {
  if (!outputFile.existsSync()) {
    throw FileSystemException(
      'The output file does not exist.',
      outputFile.path,
    );
  }

  logInfo('Starting to save Dart-to-Flutter versions to file...');

  final newContent = _generateContentFromMap(
    dartToFlutterMap: dartToFlutterMap,
  );

  // Write the generated content to the specified file.
  await outputFile.writeAsString(newContent);

  logInfo(
    'Successfully saved ${dartToFlutterMap.length} Dart-to-Flutter version mappings to ${outputFile.path}.',
  );
}

/// Generates Dart code representing a map of Dart-to-Flutter version mappings.
///
/// The generated code includes metadata comments and defines a constant map
/// variable `dartToFlutterMap` where keys are Dart SDK versions and values
/// are Flutter SDK versions.
///
/// Parameters:
/// - [dartToFlutterMap]: A map of Dart [Version] to Flutter [Version] to generate.
///
/// Returns:
/// A [String] containing the Dart code representation of the map.
String _generateContentFromMap({
  required Map<Version, Version> dartToFlutterMap,
}) {
  // Header with metadata and import statement
  const initialPart = '''
// GENERATED CODE - DO NOT MODIFY BY HAND
import 'package:pub_semver/pub_semver.dart';

/// A lookup table matching Dart SDK versions to their corresponding
/// Flutter SDK versions.
///
/// This map is generated by analyzing the stable channel release archives
/// (macOS) from:
/// https://docs.flutter.dev/release/archive#stable-channel-macos.
///
/// - **Key** (Dart SDK Version): Identifies a specific stable release of the
///   Dart SDK.
/// - **Value** (Flutter SDK Version): Identifies the corresponding stable
///   Flutter release that ships with (or supports) that Dart version.
///
/// ## Important Notes
///
/// 1. **Uniqueness**: Each Flutter version in this map appears only once,
///    ensuring a straightforward lookup from a single Dart version to a
///    single Flutter version.
/// 2. **Stability**: Entries represent only _stable_ channel releases
///    (on macOS). Other release channels (beta, dev, master) or platforms
///    might have different version alignments.
/// 3. **Autogenerated Content**: The entries in this map are generated
///    automatically. Please do not modify them manually, as any changes
///    would be overwritten the next time the map is updated.
/// 4. **Minimum Flutter Version**: The earliest Flutter version included in
///    this map is `3.0.0`, which aligns with the corresponding Dart version
///    `2.17.0`.
///
/// See also:
/// - [Dart SDK](https://dart.dev/get-dart)
/// - [Flutter SDK documentation](https://docs.flutter.dev)
final dartToFlutterMap = {
''';

  final buffer = StringBuffer(initialPart);

  // Generate each entry in the map.
  for (final entry in dartToFlutterMap.entries) {
    final dartVersionStr = entry.key.toString(); // e.g., "2.19.1"
    final flutterVersionStr = entry.value.toString(); // e.g., "3.7.1"

    buffer
      ..write('  ') // Indentation
      ..write("Version.parse('$dartVersionStr')") // Key
      ..write(': ') // Separator
      ..write("Version.parse('$flutterVersionStr'),") // Value
      ..writeln(); // Newline
  }

  // Close the map definition.
  buffer.writeln('};');

  return buffer.toString();
}
